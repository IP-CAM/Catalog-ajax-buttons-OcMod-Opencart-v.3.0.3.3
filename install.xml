<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>[OCN] Catalog Ajax Buttons</name>
  <code>ocn__catalog_ajax_buttons</code>
  <version>3.0.0.1</version>
  <author>Hkr</author>
  <link>https://forum.opencart.name/resources/20/</link>
  <date>03.06.2020</date>
  
  <file path="admin/controller/catalog/category.php">
    <operation>
      <search trim="true"><![CDATA[public function edit() {]]></search>
      <add position="before" trim="true"><![CDATA[
    // save ajax method
    public function editAjax() {
        $this->load->language('catalog/category');

        $this->load->model('catalog/category');
    
        if ($this->validateForm()) {
          $this->model_catalog_category->editCategory($this->request->get['category_id'], $this->request->post);
          $response['success'] = $this->language->get('text_success');
        } else {
          $response['error'] = $this->error;
        }
          $this->response->addHeader('Content-Type: application/json; charset=utf-8');
          $this->response->setOutput(json_encode($response));
    }
    // save ajax method
      ]]></add>
    </operation>
    <operation>
      <search trim="true"><![CDATA[$data['action'] = $this->url->link('catalog/category/edit', 'user_token=' . $this->session->data['user_token'] . '&category_id=' . $this->request->get['category_id'] . $url, true);]]></search>
      <add position="after" trim="true"><![CDATA[
            // save ajax link
			$data['action_ajax'] = $this->url->link('catalog/category/editAjax', 'user_token=' . $this->session->data['user_token'] . '&category_id=' . $this->request->get['category_id'] . $url, true);
            // save ajax link
      ]]></add>
    </operation>
  </file>
  
  <file path="admin/language/ru-ru/ru-ru.php">
    <operation>
      <search trim="true"><![CDATA[$_['button_save']                   = 'Сохранить';]]></search>
      <add position="after" trim="true"><![CDATA[$_['button_save_ajax']              = 'Сохранить и остаться';]]></add>
    </operation>
  </file>
  <file path="admin/language/en-gb/en-gb.php">
    <operation>
      <search trim="true"><![CDATA[$_['button_save']                   = 'Save';]]></search>
      <add position="after" trim="true"><![CDATA[$_['button_save_ajax']              = 'Save and stay';]]></add>
    </operation>
  </file>
  
  <file path="admin/view/template/catalog/category_form.twig">
    <operation>
      <search trim="true"><![CDATA[<button type="submit" form="form-category" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa fa-save"></i></button>]]></search>
      <add position="before" trim="true"><![CDATA[
        {# save ajax button #}
        {% if action_ajax %}
        <button data-toggle="tooltip" title="{{ button_save_ajax }}" class="btn btn-success" id="saveAjax" data-url="{{ action_ajax }}"><i class="fa fa-save"></i></button>
        {% endif %}
        {# save ajax button #}
      ]]></add>
    </operation>
    <operation>
      <search trim="true"><![CDATA[{{ footer }}]]></search>
      <add position="before" trim="true"><![CDATA[
        {# save ajax script #}
        <script>
          $('#saveAjax').on('click', function () {
            $('.alert').remove();
            $('.has-error').removeClass('has-error');
            $('.text-danger').remove();
        
            let buttonSaveAjax = $('#saveAjax');
            let buttonSave = $('button[type=submit]');
            let buttonReturn = $('a.btn.btn-default');
            const urlAjax = buttonSaveAjax.attr('data-url')
        
            $.ajax({
              type: 'post',
              data: $('form').serialize(),
              url: urlAjax,
              dataType: 'json',
              beforeSend: function() {
                buttonSaveAjax.prop('disabled', true);
                buttonSave.prop('disabled', true);
                buttonReturn.attr('disabled', true);
                buttonSaveAjax.find('i.fa').removeClass('fa-save').addClass('fa-spinner fa-pulse');
              },
              complete: function() {
                buttonSaveAjax.prop('disabled', false);
                buttonSave.prop('disabled', false);
                buttonReturn.attr('disabled', false);
                buttonSaveAjax.find('i.fa').removeClass('fa-spinner fa-pulse').addClass('fa-save');
              },
              success: function(response) {
                let listErrors = '';
                let alertMessage = response.success;
                let alertColor = 'success';
                if (response.error) {
                  listErrors += '<ul>'
        
                  if (response.error.name) {
                    for (let key in response.error.name) {
                      $('label[for=input-name' + key + ']').parent().addClass('has-error');
                      let alertErrorInput = '<div class="text-danger">' + response.error.name[key] + '</div>';
                      $('#input-name' + key).parent().append(alertErrorInput);
                    }
                    listErrors += '<li>' + response.error.name[1] + '</li>';
                  }
        
                  if (response.error.meta_title) {
                    for (let key in response.error.meta_title) {
                      $('label[for=input-meta-title' + key + ']').parent().addClass('has-error');
                      let alertErrorInput = '<div class="text-danger">' + response.error.meta_title[key] + '</div>';
                      $('#input-meta-title' + key).parent().append(alertErrorInput);
                    }
                    listErrors += '<li>' + response.error.meta_title[1] + '</li>';
                  }
        
                  if (response.error.keyword) {
                    for (let first in response.error.keyword) {
                      for (let second in response.error.keyword[first]) {
                        let alertErrorInput = '<div class="text-danger">' + response.error.keyword[first][second] + '</div>';
                        $('input[name="category_seo_url[' + first + '][' + second + ']"]').parent().addClass('has-error').after(alertErrorInput);
                      }
                    }
                    listErrors += '<li>' + response.error.keyword[0][1] + '</li>';
                  }
        
                  if (response.error.parent) {
                    $('label[for=input-parent]').parent().addClass('has-error');
                    let alertErrorInput = '<div class="text-danger">' + response.error.parent + '</div>';
                    $('#input-parent').parent().append(alertErrorInput);
                    listErrors += '<li>' + response.error.parent + '</li>';
                  }
        
                  listErrors += '</ul>';
        
                  alertMessage = response.error.warning;
                  alertColor = 'danger';
                }
                let alertBlock = '<div class="alert alert-' + alertColor + ' alert-dismissible"><i class="fa fa-exclamation-circle"></i>' + alertMessage + '<button type="button" class="close" data-dismiss="alert">&times;</button>' + listErrors + '</div>';
                $('#content > .container-fluid').prepend(alertBlock);
              },
              error: function(error) {
                alert(error)
              }
            });
          })
        </script>
        {# save ajax script #}
      ]]></add>
    </operation>
  </file>
  
</modification>